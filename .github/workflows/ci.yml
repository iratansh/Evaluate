name: CI/CD Pipeline

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  backend-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'
    
    - name: Run backend tests
      run: |
        cd backend
        chmod +x mvnw
        ./mvnw test -B
    
    - name: Test API endpoints
      run: |
        cd backend
        chmod +x mvnw
        ./mvnw package -DskipTests -B -q
        java -jar target/ai-interviewer-1.0.0.jar &
        
        # Wait for Spring Boot to start
        echo "Waiting for backend to start..."
        for i in $(seq 1 30); do
          if curl -s http://localhost:8000/health/ > /dev/null 2>&1; then
            echo "Backend is up!"
            break
          fi
          sleep 2
        done
        
        # Test health endpoint
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health/)
        if [ "$STATUS" != "200" ]; then echo "✗ Health check failed ($STATUS)"; exit 1; fi
        echo "✓ Health check passed"
        
        # Test root endpoint
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/)
        if [ "$STATUS" != "200" ]; then echo "✗ Root endpoint failed ($STATUS)"; exit 1; fi
        echo "✓ Root endpoint passed"
        
        # Test domains endpoint
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/api/interview/domains)
        if [ "$STATUS" != "200" ]; then echo "✗ Domains endpoint failed ($STATUS)"; exit 1; fi
        echo "✓ Domains endpoint passed"
        
        # Test session creation
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8000/api/interview/sessions \
          -H "Content-Type: application/json" \
          -d '{"domain":"software_engineering","difficulty":"medium","duration_minutes":15}')
        if [ "$STATUS" != "200" ]; then echo "✗ Session creation failed ($STATUS)"; exit 1; fi
        echo "✓ Session creation passed"
        
        echo "All API tests passed!"
        
        # Stop the server
        kill %1 2>/dev/null || true

  frontend-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci
    
    - name: Run ESLint
      run: |
        cd frontend
        npm run lint
    
    - name: Build frontend
      run: |
        cd frontend
        npm run build
    
    - name: Check TypeScript
      run: |
        cd frontend
        npx tsc --noEmit

  docker-build:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Test Docker Compose build
      run: |
        docker compose build --no-cache
        docker compose config
    
    - name: Test production Docker build
      run: |
        docker compose -f docker-compose.prod.yml build --no-cache
        docker compose -f docker-compose.prod.yml config